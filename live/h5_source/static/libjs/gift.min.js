!function(){function t(t,e){return t.currentStyle?t.currentStyle[e]:getComputedStyle(t)[e]}var e=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),a={};a.support=function(){return!!document.createElement("canvas").getContext&&!!(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame)}(),a.list={},a._getBinaryContent=function(){function t(){try{return new window.XMLHttpRequest}catch(t){}}function e(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}var a={};a._getBinaryFromXHR=function(t){return t.response||t.responseText};var i=window.ActiveXObject?function(){return t()||e()}:t;return a.getBinaryContent=function(t,e){try{var n=i();n.open("GET",t,!0),"responseType"in n&&(n.responseType="arraybuffer"),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(i){var r,s;if(4===n.readyState)if(200===n.status||0===n.status){r=null,s=null;try{r=a._getBinaryFromXHR(n)}catch(t){s=new Error(t)}e(s,r)}else e(new Error("Ajax error for "+t+" : "+this.status+" "+this.statusText),null)},n.send()}catch(t){e(new Error(t),null)}},a.getBinaryContent}(),a.animate=function(t,i,n){function r(a){if(f||(f=a),d=Math.floor((a-f)/o),d<h){var i=g[d];m.clearRect(0,0,t.width,t.height),m.drawImage(i,0,0,l,c,0,0,t.width,t.height)}d>=h?(m.clearRect(0,0,t.width,t.height),n()):e(r)}var s,h,o,l,c,g,m=t.getContext("2d"),u=i.giftid,d=0,f=0;if(!m)return n(new Error("your browser don't support canvas")),!1;if(a.list[u]&&a.list[u].images.length>0)s=i.animationtime,h=a.list[u].images.length,o=s/h,g=a.list[u].images,l=g[0].width,c=g[0].height,t.width=l,t.height=c,e(r);else{var w=a.list[u]={};w.name=i.name,w.animationtime=i.animationtime,w.images=[],a._getBinaryContent(i.fileurl,function(m,d){if(m)return a.list[u]=null,void n(m);var f=new JSZip;f.loadAsync(d).then(function(t){var e=t.file(/^[0-9]{1,}.png$/),i=[];e.sort(function(t,e){return parseInt(t.name)-parseInt(e.name)});for(var n=0,r=e.length;n<r;n++)i.push(e[n].async("base64").then(function(t){return t}));return JSZip.external.Promise.all(i).then(function(t){for(var e=0;e<t.length;e++){var a=new Image;a.src="data:image/png;base64,"+t[e],w.images[e]=a}},function(e){a.list[u]=null,t=null})}).then(function(){if(s=i.animationtime,h=a.list[u].images.length,!(h>0))throw a.list[u]=null,new Error("can't find images");o=s/h,g=a.list[u].images,l=g[0].width,c=g[0].height,t.width=l,t.height=c,e(r)},function(t){a.list[u]=null,f=null}).then(function(){f=null},function(t){a.list[u]=null,f=null,n(t)})})}},a.enter=function(){var i={ctx:null,canvas:null,type:null,width:750,height:1334,screenTpy:1};i.animate=function(c,g,m){function u(t){f||(f=t);var a=t-f;if(a<=8e3){switch(i.ctx.clearRect(0,0,i.width,i.height),l.draw(a),h.draw(a),s.draw(a),o.draw(a),i.type){case 1:n.draw(a);break;case 2:r.draw(a)}e(u)}else i.ctx.clearRect(0,0,i.width,i.height),i.canvas.style.backgroundColor="transparent",m&&m()}function d(t){t.sort(function(t,e){return t=t.name.match(/([0-9]+)\.png/)[1],e=e.name.match(/([0-9]+)\.png/)[1],t=parseInt(t),e=parseInt(e),t-e})}var f;if(!c.getContext("2d"))return void(m&&m(new Error("this is not a canvas element")));i.ctx=c.getContext("2d"),i.canvas=c,i.type=g.type,o.image=new Image,o.ready=!1,o.image.onload=function(){o.ready=!0},o.image.src=g.avatar;var w,p;if(w=t(c,"width"),w=parseInt(w),p=t(c,"height"),p=parseInt(p),w>p&&(i.width=2373,i.screenTpy=2),c.width=i.width,c.height=i.height,c.style.backgroundColor="rgba(0, 0, 0, 0.4)",1==i.load)e(u);else{var v=(location.hostname.indexOf("test1")==-1,"static.yizhibo.com");a._getBinaryContent("//"+v+"/js/libs/gift/zips/enter.zip",function(t,a){if(t)return i.load=!1,void(m&&m(t));var o=new JSZip;o.loadAsync(a).then(function(t){var e=t.file(/^mingxing\/[0-9]{1,}.png$/),a=t.file(/^shenhao\/[0-9]{1,}.png$/),o=t.file(/^light\/[0-9]{1,}.png$/),l=t.file(/^back\/[0-9]{1,}.png$/),c=[];d(e),d(a),d(o),d(l);for(var g=0;g<e.length;g++)c.push(e[g].async("base64"));for(var g=0;g<a.length;g++)c.push(a[g].async("base64"));for(var g=0;g<o.length;g++)c.push(o[g].async("base64"));for(var g=0;g<l.length;g++)c.push(l[g].async("base64"));return JSZip.external.Promise.all(c).then(function(t){t=t.map(function(t,e,a){var i=new Image;return i.src="data:image/png;base64,"+t,i}),n.images=t.splice(0,e.length),r.images=t.splice(0,a.length),s.images=t.splice(0,o.length),h.images=t.splice(0,l.length)},function(e){i.load=!1,t=null})}).then(function(){e(u)}).then(function(){i.load=!0,o=null},function(t){i.load=!1,o=null,m&&m(t)})})}};var n={images:[],X:125,Y:310,X1:540.6,Y1:156.6,interval:40,draw:function(t){var e=Math.floor(t/this.interval);e>=this.images.length&&(e=this.images.length-1),1==i.screenTpy?i.ctx.drawImage(this.images[e],this.X,this.Y):(i.ctx.save(),i.ctx.scale(1.5,1.5),i.ctx.drawImage(this.images[e],this.X1,this.Y1),i.ctx.restore())}},r={images:[],X:123,Y:308,X1:539,Y1:155,interval:40,draw:function(t){var e=Math.floor(t/this.interval);e>=this.images.length&&(e=this.images.length-1),1==i.screenTpy?i.ctx.drawImage(this.images[e],this.X,this.Y):(i.ctx.save(),i.ctx.scale(1.5,1.5),i.ctx.drawImage(this.images[e],this.X1,this.Y1),i.ctx.restore())}},s={images:[],startTime:2400,interval:100,step:.5233,angle:0,draw:function(t){if(t>this.startTime){var e=parseInt((t-this.startTime)/this.interval);e<16&&(this.angle=15*Math.PI/180*(Math.sin(e*Math.PI/15-Math.PI/2)+1)/2),e>=20&&e<45&&(e-=5,this.angle=15*Math.PI/180*Math.sin(e*Math.PI/30));var a=i.ctx;1==i.screenTpy?(a.save(),a.translate(220,-25),a.scale(2,2),a.rotate(-this.angle),a.drawImage(this.images[0],-220,-25),a.restore(),a.save(),a.translate(530,-25),a.scale(2,2),a.rotate(this.angle),a.drawImage(this.images[1],-530,-25),a.restore()):(a.save(),a.translate(1031,-25),a.scale(2,2),a.rotate(-this.angle),a.drawImage(this.images[0],-220,-25),a.restore(),a.save(),a.translate(1341,-25),a.scale(2,2),a.rotate(this.angle),a.drawImage(this.images[1],-530,-25),a.restore())}}},h={images:[],startTime:2400,interval:100,opacity:1,draw:function(t){if(t>this.startTime){var e=parseInt((t-this.startTime)/this.interval);this.opacity=(Math.cos(e/10*Math.PI)+1)/2;var a=i.ctx;1==i.screenTpy?(a.save(),a.globalAlpha=this.opacity,a.drawImage(this.images[0],0,0),a.globalAlpha=1-this.opacity,a.drawImage(this.images[1],0,0),a.restore()):(a.save(),a.globalAlpha=this.opacity,a.drawImage(this.images[0],50,0),a.drawImage(this.images[1],811,0),a.drawImage(this.images[0],1573,0),a.globalAlpha=1-this.opacity,a.drawImage(this.images[1],100,0),a.drawImage(this.images[0],811,0),a.drawImage(this.images[1],1523,0),a.restore())}}},o={X:285,Y:392,X1:699,Y1:239,r:92,image:"",ready:!1,draw:function(t){if(1==this.ready){var e=i.ctx;1==i.screenTpy?(e.save(),e.beginPath(),e.arc(this.X+this.r,this.Y+this.r,this.r,0,2*Math.PI),e.fillStyle="#fff",e.closePath(),e.fill(),e.globalCompositeOperation="source-atop",e.drawImage(this.image,0,0,this.image.width,this.image.height,this.X,this.Y,2*this.r,2*this.r),e.restore()):(e.save(),e.scale(1.5,1.5),e.beginPath(),e.arc(this.X1+this.r,this.Y1+this.r,this.r,0,2*Math.PI),e.fillStyle="#fff",e.closePath(),e.fill(),e.globalCompositeOperation="source-atop",e.drawImage(this.image,0,0,this.image.width,this.image.height,this.X1,this.Y1,2*this.r,2*this.r),e.restore())}}},l={startTime:6960,interval:40,opacity:1,draw:function(t){if(t>this.startTime){var e=parseInt((t-this.startTime)/this.interval);this.opacity=1-e/25}else this.opacity=1;i.canvas.style.opacity=this.opacity}};return i.animate}(),window.canvasgift=a}();